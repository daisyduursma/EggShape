
---
title: "Thermal Stress"
output: html_document
---

Exploration of traits that reduce thermal stress in Austrlia.
4 data files needed to run code:
  Traits
  Choa raster
  Occurange matrix
  Average annual VPD

```{r,warning=FALSE,message=FALSE}


rm(list = ls())

library(raster)
library(RColorBrewer)
#library(lattice)
#library(maptools)
#library(letsR)
#library(plantecophys)
library(car)
#library(mgcv)
library(ncf)
library(spdep)
#library(resample)
library(lme4)
library(plyr)
library(multcomp)

resetPar <- function() {
    dev.new()
    op <- par(no.readonly = TRUE)
    dev.off()
    op
}

asNumeric <- function(x) as.numeric(as.character(x))
factorsNumeric <- function(d) modifyList(d, lapply(d[, sapply(d, is.factor)], asNumeric))


SACPrepMoranDistance<-function (lmModels, distkm, neighborStyle,coords){
  disNB<-dnearneigh(coords, 0, distkm,longlat=TRUE) #turns neighbourhood object into a weighted list
  listWeight<-nb2listw(disNB, glist=NULL, style=neighborStyle, zero.policy=FALSE)
  #moran.test(residuals(lmModels), listw=listWeight)
  SARlm <- errorsarlm(lmModels, listw=listWeight)
  #summary(SARlm, Nagelkerke=TRUE) #Gives a summary of the SAR error model

  coeffcnt<-as.numeric(SARlm$coefficients[2])
  SE<- as.numeric(SARlm$rest.se[2])
  lmAIC<-SARlm$AIC_lm.model # this is AIC of lm
  sarAIC<-AIC(SARlm)
  NagelkerkePseudoRsquared<-summary(SARlm, Nagelkerke=TRUE)[[47]]
  #get values  of Moranâ€™s I over the first twenty distance groupings
  correlo <- correlog(coords[,1], coords[,2], residuals(SARlm),
na.rm=T, increment=1, resamp=0)
  MoransI20distGroup <-sum(correlo$correlation[1:20])
  outdat<-t(c(distkm,neighborStyle,lmAIC,sarAIC,MoransI20distGroup,coeffcnt,SE,NagelkerkePseudoRsquared))
  colnames(outdat)<-c("SACdistance","neighborStyle","lmAIC","sarAIC","MoransI20distGroup","regression coefficients","SE","NagelkerkePseudo-R-squared")
 return(outdat)
}

#data
#traits
traits<-read.csv('/Users/daisy/Google Drive/PhD/ThermalStress/tables/Table_S1_20161128.csv')
#occurence records
Occ<-read.csv("~/Google Drive/PhD/ThermalStress/data/PassarineObservationsGriddedFinal2016-06-21.csv")
Occ<-unique(Occ)
#choa index
#completeness index
aus<-raster("/Users/daisy/Google Drive/PhD/ThermalStress/data/CmpltDomeCupGridCells2016-11-30.asc")
#Chao<-rasterToPoints(ChaoR)
# # 1 degrees mask of Austrlaia where each gridcell has unique ID
# aus<-ChaoR
# aus[]<-1:1505 #Give each grid cell unique value
# aus<-raster::mask(aus,ChaoR)#keep only cells interested in

#####################
#get summary values for elongation
####################
length(na.omit(traits$Elongation))
min(na.omit(traits$Elongation))
max(na.omit(traits$Elongation))
mean(na.omit(traits$Elongation))
sd(na.omit(traits$Elongation))
hist(na.omit(traits$Elongation))
## Check if normally distributed
qqPlot(na.omit(traits$Elongation));qqline(na.omit(traits$Elongation), col = 2)
#elongation by nest type
nest.type<-ddply(traits,~Nest.type,summarise,mean=mean(na.omit(Elongation)),sd=sd(na.omit(Elongation)),n=length(na.omit(Elongation)))
plot(Elongation ~ Nest.type, data=traits)
#significantly differnt?
mod1<-lm(Elongation ~ Nest.type,data=traits)
summary(mod1)
Anova(mod1, test.statistic="F")
#mod2<-lmer(Elongation ~ Nest.type+ (1+Nest.type|Family),REML=T,data=traits)
glht(mod1, linfct=mcp(Nest.type="Tukey"))#find differencs between regions
# summary(TukeyNestLoc)






#number of families
length(unique(traits$Family))
table(traits$Family)
BF<-subset(traits,Family=="Meliphagidae")
BFnames <- do.call("rbind",(lapply(BF$Species, as.character)))
BFgns<-sapply(strsplit(BFnames, " ") , "[[", 1)
length(unique(BFgns))


#number of genus
names <- do.call("rbind",(lapply(traits$Species, as.character)))
gns<-sapply(strsplit(names, " ") , "[[", 1)
length(unique(gns))
table(gns)


#geographic range size (number of gridcells)
range<-as.data.frame(table(Occ$Species))
hist(range$Freq)
max(range$Freq)



# #elongation by nest location
# nest.loc<-ddply(traits,~Nest.location,summarise,mean=mean(na.omit(Elongation)),sd=sd(na.omit(Elongation)),n=length(na.omit(Elongation)))
# t2<-droplevels(subset(traits,Nest.location=="Cliff"|
#                   Nest.location=="Cavity"|
#                   Nest.location=="Ground"|
#                   Nest.location=="Vegetation"))
# plot(Elongation ~ Nest.location, data=t2)
# modEL<-lmer(Elongation ~ Nest.location+ (1+Nest.location|Family),REML=T,data=t2)
# Anova(modEL, test.statistic="F") 
# TukeyNestLoc<- glht(modEL, linfct=mcp(Nest.location="Tukey"))#find differencs between regions
# summary(TukeyNestLoc)

###############################

# Figure 1 Density distribution of egg elongation in Australia bird species (n = 298) and clades (n = ).

##################################
#make histograms of elongation by species and clade
pdf(file = "/Users/daisy/Google Drive/PhD/ThermalStress/figures/manuscript/DensityDistEggElongation.pdf",
       width = 3.15, height = 3.15)

par(mfrow=c(1,1), mar=c(5,4,1,1), las=1, cex=.8, xaxs="i",
    yaxs = "i")
hist(na.omit(traits$Elongation),freq=FALSE,col=rgb(0.1,0.1,0.1,0.5),xlim=c(1,1.7),main=NULL,xlab="Egg elongation",cex=".5")  

dev.off()


        # #95% CI
        # error <- qt(0.975,df=length(na.omit(traits$Elongation))-1)*sd(na.omit(traits$Elongation))/sqrt(length(na.omit(traits$Elongation)))
        # left <- mean(na.omit(traits$Elongation))-error
        # right <- mean(na.omit(traits$Elongation))+error
        # #data within 3sd of mean
        # stDev<-sd(na.omit(traits$Elongation))
        # mean(na.omit(traits$Elongation))-3*sd(na.omit(traits$Elongation))
        # mean(na.omit(traits$Elongation))+3*stDev
        # 



#occurance records masked by completeness index
species <- unique(Occ$Species)
Occ<-unique(Occ[,c('Species','x',"y")])
Occ<-merge(Occ, Chao, by =c("x","y"),all.x=TRUE)
Occ<-subset(Occ,Cmplt100==1)
Occ$ID<-raster::extract(aus,cbind(Occ$x,Occ$y))#Grid cell ID for each presence record

#variation in gridcell occupancy
rangecount<-as.data.frame(table(Occ$Species))
hist(rangecount$Freq)
summary(rangecount$Freq)

#species richness
richness<-as.data.frame(table(Occ$ID))
hist(richness$Freq)
summary(richness$Freq)

#Data museaum measurements
spDat <- read.csv("~/Google Drive/PhD/ThermalStress/data/151124_otherSpecies_egg_collection_details_rearranged.csv")

#VPD
VPDann<-raster("/Users/daisy/Google Drive/PhD/Data/Spatial/Climate/averageAnnualVPD.asc")
VPDann<-raster::resample(VPDann,ChaoR,method="ngb")*ChaoR

 plot(VPDann,col=rev(heat.colors(20)),main="Annual VPD (kPa)")

#Map of koeppen area
koeppen<-raster(paste0('/Users/daisy/Google Drive/PhD/Data/Spatial/BOM_climate_zones/kpngrp_major/koepenReclassified.asc'),
                proj4string=CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))
#combine equatorial and tropical: 41 Equatorial, 35 Tropical
m <- c(35, 41, 35)
rclmat <- matrix(m, ncol=3, byrow=TRUE)
koeppen<- reclassify(koeppen,rclmat)
Occ$koeppen<-raster::extract(koeppen,cbind(Occ$x,Occ$y))

#area of gridcells
areaR<-raster::area(VPDann)
Occ$GridArea<-raster::extract(areaR,cbind(Occ$x,Occ$y))

```

Get the average value for elongation in each gridcell 
and the proportion species inside a gridcell that have roofed nests and other types of nests

```{r, echo=FALSE}

#pull out species with most extreme values and subset occ so not included
#this is to test that they not effecting results becaust they do somtime fallout of the CI for qqPlots
        # extSp<-subset(traits, Elongation > 1.2 | Elongation < 1.6)$Species
        # Occ<-Occ[Occ$Species %in% extSp, ]


locs<-unique(Occ$ID)
message(paste0("Number of 1 degree grid cells being used = ",length(locs)))
message(paste0("Number of Passarine species in study = ",length(unique(Occ$Species))))

#loop through cells and get average trait values
celltraitPass<-list()
for(lc in 1:length(locs)){ 
  sp<-subset(Occ,ID==locs[lc])$Species
  if(length(sp)<=10){
    next()
  }
  tr<-traits[traits$Species %in% sp,]#pull out the traits for the species of interest
  eggElong<-mean(na.omit(tr$Elongation))
  trNoCav<-traits[traits$Species %in% sp & traits$Nest.location != "Cavity",]
  trNoCavEnclosed<-trNoCav[trNoCav$Exposure == "Enclosed",]
  trNoCavOpen<-trNoCav[trNoCav$Exposure == "Open",]
  eggElongNoCav<-mean(na.omit(trNoCav$Elongation))
  encl<-nrow(tr[tr$Exposure == "Enclosed",])
  openCount<-nrow(tr[tr$Exposure == "Open",])
  enclNoCav<-nrow(tr[tr$Exposure == "Enclosed" & tr$Nest.location != "Cavity",])
  openNoCav<-nrow(tr[tr$Exposure == "Open" & tr$Nest.location != "Cavity",])
  propEnclosed<-encl/(encl+openCount)
  propEnclosedNoCav<-enclNoCav/(enclNoCav+openNoCav)
  Ecol<-mean(na.omit(tr$EggColour))
  Espot<-mean(na.omit(tr$EggSpotting))
  EcolNoCav<-mean(na.omit(trNoCav$EggColour))
  EspotNoCav<-mean(na.omit(trNoCav$EggSpotting))
  EcolNoCavOpen<-mean(na.omit(trNoCavOpen$EggColour))
  EspotNoCavOpen<-mean(na.omit(trNoCavOpen$EggSpotting))
  EcolNoCavEnclosed<-mean(na.omit(trNoCavEnclosed$EggColour))
  EspotNoCavEnclosed<-mean(na.omit(trNoCavEnclosed$EggSpotting))
  celltraitPass[[lc]]<-c(locs[lc],
                      eggElong,eggElongNoCav,propEnclosed,
                      propEnclosedNoCav, Ecol, Espot,
                      EcolNoCav,EspotNoCav,EcolNoCavOpen,
                      EcolNoCavEnclosed,openCount,
                      EspotNoCavOpen,EspotNoCavEnclosed)
}
celltraitPass<-as.data.frame(do.call("rbind",celltraitPass))
colnames(celltraitPass)<-c("ID",
                       "eggElong",
                       "eggElongNoCav",
                       "propEnclosed",
                       "propEnclosedNoCav",
                       "eggColour",
                       "eggSpotting",
                       "eggColourNoCav",
                       "EggSpottingNoCavity",
                       "EcolNoCavOpen",
                       "EcolNoCavEnclosed",
                       "openCount",
                       "EspotNoCavOpen",
                       "EspotNoCavEnclosed")

#make raster layers of grid cell assemblages
elongPass<-subs(aus,
             data.frame(celltraitPass[,c("ID","eggElong")]))
plot(elongPass,main="Elongation")
c(minValue(elongPass), maxValue(elongPass))

eggElongNoCav<-subs(aus,
             data.frame(celltraitPass[,c("ID","eggElongNoCav")]))
plot(eggElongNoCav,main="Elongation, no cavity nesters")

propEnclosed<-subs(aus,
             data.frame(celltraitPass[,c("ID","propEnclosed")]))
plot(propEnclosed,main="Enclosed")
c(minValue(propEnclosed), maxValue(propEnclosed))

propEnclosedNoCav<-subs(aus,
             data.frame(celltraitPass[,c("ID","propEnclosedNoCav")]))
plot(propEnclosedNoCav,main="Enclosed - no cavity")
c(minValue(propEnclosedNoCav), maxValue(propEnclosedNoCav))


# eggColour<-subs(aus,
#              data.frame(celltraitPass[,c("ID","eggColour")]))
# plot(eggColour,main="eggColour")
# c(minValue(eggColour), maxValue(eggColour))

# eggColourNoCav<-subs(aus,
#              data.frame(celltraitPass[,c("ID","eggColourNoCav")]))
# plot(eggColourNoCav,main="eggColour-No Cavity")
# c(minValue(eggColourNoCav), maxValue(eggColourNoCav))


# eggSpot<-subs(aus,
#              data.frame(celltraitPass[,c("ID","eggSpotting")]))
# plot(eggSpot,main="eggSpotting")
# c(minValue(eggSpot), maxValue(eggSpot))

# eggSpotNoCav<-subs(aus,
#              data.frame(celltraitPass[,c("ID","EggSpottingNoCavity")]))
# plot(eggSpotNoCav,main="egg spotting - no cavity")
# c(minValue(eggSpotNoCav), maxValue(eggSpotNoCav))

EcolNoCavOpen<-subs(aus,
             data.frame(celltraitPass[,c("ID","EcolNoCavOpen")]))
plot(EcolNoCavOpen,main="Egg Colour - Open - no cavity")
c(minValue(EcolNoCavOpen), maxValue(EcolNoCavOpen))


# EcolNoCavEnclosed<-subs(aus,
#              data.frame(celltraitPass[,c("ID","EcolNoCavEnclosed")]))
# plot(EcolNoCavEnclosed,main="Egg Colour - Enclosed - no cavity")
# c(minValue(EcolNoCavEnclosed), maxValue(EcolNoCavEnclosed))


EspotNoCavOpen<-subs(aus,
             data.frame(celltraitPass[,c("ID","EspotNoCavOpen")]))
plot(EspotNoCavOpen,main="Egg spot - Open - no cavity")
c(minValue(EspotNoCavOpen), maxValue(EspotNoCavOpen))


openCount<-subs(aus,
             data.frame(celltraitPass[,c("ID","openCount")]))
plot(openCount,main="Open Count")
c(minValue(openCount), maxValue(openCount))





# EspotNoCavEnclosed<-subs(aus,
#              data.frame(celltraitPass[,c("ID","EspotNoCavEnclosed")]))
# plot(EspotNoCavEnclosed,main="Egg spot - Enclosed - no cavity")
# c(minValue(EspotNoCavEnclosed), maxValue(EspotNoCavEnclosed))







```

make histograms of random grid cells and the traits of the species within those gridcells

The data for elongation and proportion of nests is normally distributed.

For elongation, I randomly checked 40 grid cells, elongation values within gridcells is also normally distributed

The within gridcell data used to calculate proportion is binary

```{r, echo=FALSE}
 

op <- par(mfrow = c(5,4),
          oma = c(5,4,1,0) + 0.1,
          mar = c(2,0,2,1) + 0.1)

IDs<-sample(locs, 40)
#loop through cells and get average trait values
for(j in 1:length(IDs)){ 
  sp<-subset(Occ,ID==IDs[j])$Species
  #get species level data
  tr<-traits[traits$Species %in% sp,]#pull out the traits for the species of interest
  tr<-tr[,"Elongation"]
  qqPlot(tr, main =subset(Occ,ID==IDs[j])[1,c("x","y")] )#data is normal if it falls within the confident interval
}


```
the data is normally distributed, but the two species that have the roundedest shape sometimes fall outside of the qqPlots confidence intervals, check results are the same when excluding the 2 roundest and the 2 most elongated

```{r, echo=FALSE}


elong<-rasterToPoints(elongPass)
elongNoC<-rasterToPoints(eggElongNoCav)
encl<-rasterToPoints(propEnclosed)
enclNoC<-rasterToPoints(propEnclosedNoCav)
open<-rasterToPoints(EcolNoCavOpen)
spot<-rasterToPoints(EspotNoCavOpen)
VPDAnnual<-rasterToPoints(VPDann)
colnames(VPDAnnual)<-c("x","y","VPDAnnual")
dat<-merge.data.frame(elong,elongNoC,by=c("x","y"))
dat<-merge.data.frame(dat,encl,by=c("x","y"))
dat<-merge.data.frame(dat,enclNoC,by=c("x","y"))
dat<-merge.data.frame(dat,VPDAnnual,by=c("x","y"))
dat<-merge.data.frame(dat,open,by=c("x","y"))
dat<-merge.data.frame(dat,spot,by=c("x","y"))

```

Slight variation from normally distribuition.
although proportions are typically treated binomial in this case it is a continous variable,


```{r, echo=FALSE}
par(mfrow=c(1,1))
qqPlot(dat$eggElong,pch=20,
       main = "Residuals",ylab="Elongation")
qqPlot(dat$eggElongNoCav,pch=20,
       main = "Residuals",ylab="Elongation - no cavity")
qqPlot(dat$VPDAnnual,pch=20,
       main = "Residuals",ylab="VPD")
qqPlot(dat$propEnclosed,pch=20, 
       ylab = "Enclosed", main = "Residuals")
qqPlot(dat$propEnclosedNoCav,pch=20, 
       ylab = "Enclosed - no cavity", main = "Residuals")
qqPlot(dat$EcolNoCavOpen,pch=20, 
       ylab = "Egg Colour, open nests", main = "Residuals")
qqPlot(dat$EspotNoCavOpen,pch=20, 
       ylab = "Egg spot, open nests", main = "Residuals")



```
Run ordinary least squares to fit linear-regression model, follow by SAR model to add an error term for spatial autocorrelation


```{r}


# linear models
summary(lmEl <- lm(eggElong ~ VPDAnnual, data=dat))
summary(lmElNC <- lm(eggElongNoCav ~ VPDAnnual, data=dat))
summary(lmEnc <- lm(propEnclosed ~ VPDAnnual, data=dat))
summary(lmEncNC <- lm(propEnclosedNoCav ~ VPDAnnual, data=dat))

# test of spatial autocorrelation
GridCoords<-as.matrix(cbind(dat$x,dat$y))
nlist<-dnearneigh(GridCoords,d1=0,d2=2) #distances are in degrees, 
listWeight<-nb2listw(nlist, style="W")
moran.test(residuals(lmEl), listw=listWeight)
moran.test(residuals(lmEnc), listw=listWeight)
moran.test(residuals(lmElNC), listw=listWeight)
moran.test(residuals(lmEncNC), listw=listWeight)


```
The resulting p values from moran.test support the conclusion that the errors in both models are spatially autocorrelated, run a spatial error model - simultaneous autoregressive model (SAR). Run SAR model with weighted lists

```{r}

#error -  200 km, W
elongNB<-dnearneigh(GridCoords, 0, 200,longlat=TRUE) #turns neighbourhood object into a weighted list
elonglistWeight<-nb2listw(elongNB, glist=NULL, style="W", zero.policy=FALSE)
#SAR models
summary(SARlmEl <- errorsarlm(lmEl, listw=elonglistWeight),
        Nagelkerke=T) #sig
summary(SARlmElNC <- errorsarlm(lmElNC, listw=elonglistWeight),
        Nagelkerke=T)#sig
summary(SARlmEnc <- errorsarlm(lmEnc, listw=elonglistWeight),
        Nagelkerke=T)#sig
summary(SARlmEncNC <- errorsarlm(lmEncNC, listw=elonglistWeight),
        Nagelkerke=T)#n.s.

```
look at colour
```{r,echo=TRUE} 

qqPlot(dat$EcolNoCavOpen,pch=20,
       main = "Residuals",ylab="colour")
qqPlot(dat$EspotNoCavOpen,pch=20,
       main = "Residuals",ylab="spot")



par(mfrow=c(2,2))
breakpoints <- seq(1,2.9,0.2)
rgb.palette <-
        colorRampPalette(c("darkgreen",
                  "orange",
                  "darkblue"),
                  space = "rgb")
 
colors <- rgb.palette(9)
plot(eggColour,breaks=breakpoints,col=colors, main = "All Species")
plot(eggColourNoCav,breaks=breakpoints,col=colors, main = "No cavity nesting species")
plot(EcolNoCavOpen,breaks=breakpoints,col=colors, main = "Open nests")
plot(EcolNoCavEnclosed,breaks=breakpoints,col=colors, main = "Enclosed nests, no cavity")
plot(EspotNoCavOpen,breaks=breakpoints,col=colors, main = "Open nests")
plot(EspotNoCavEnclosed,breaks=breakpoints,col=colors, main = "Enclosed nests, no cavity")

#SAR model of open nests and VPD

summary(lmColour <- lm(EcolNoCavOpen ~ VPDAnnual, data=dat))

#summary(lmSpot <- lm(EspotNoCavOpen ~ VPDAnnual, data=dat))

summary(SARlmColour <- errorsarlm(lmColour, listw=elonglistWeight),
        Nagelkerke=T) #sig

# summary(SARlmSpot <- errorsarlm(lmSpot, listw=elonglistWeight),
#         Nagelkerke=T) #sig


######################

#Figure 2

######################
pdf(file = "/Users/daisy/Google Drive/PhD/ThermalStress/figures/manuscript/ElongationProportionMapsPlots.pdf",
       width = 7.48, height = 6)

par(mfrow = c(2,2),          
  mar = c(2,0,2,1) + 0.1)
  
rgb.palette <-
        colorRampPalette(c("darkgreen",
                  "orange",
                  "darkblue"),
                  space = "rgb")
 
plot(elongPass,col=rgb.palette(20),axes=F,legend=F,box=F)
text(114,-12,"(a)")
plot(elongPass,
     legend.only=T,
     col=rgb.palette(20),
     legend.width=1,
     legend.shrink=0.5,
     cex.axis=0.6,
      smallplot=c(0.18,0.22, 0.2,0.33),
      axis.args=list(cex.axis=0.7))

par(mar =  c(4, 4, 1, 1)) 
with(dat,plot(eggElong ~ VPDAnnual,
              pch="o",
              cex=0.6,
              xlab="VPD (kPa)", 
              ylab = "Elongation",
              frame=F))
box(which = "plot", bty = "l")
    abline(SARlmEl$coefficients[1],SARlmEl$coefficients[2],col="blue",lwd=2)
myr2 = bquote(italic(R)^2 == 0.72)
text(x = 1.5, y = 1.35, labels = myr2)
 
##Proportion covered
    
    par(mar = c(2,0,2,1) + 0.1)
    plot(propEnclosed,col=rgb.palette(20),axes=F,legend=F,box=F)
text(114,-12,"(b)")
plot(propEnclosed,
     legend.only=T,
     col=rgb.palette(20),
     legend.width=1,
     legend.shrink=0.5,
     cex.axis=0.6,
      smallplot=c(0.18,0.22, 0.2,0.33),
      axis.args=list(cex.axis=0.7,
      at=seq(.25,.45, .1),
      labels=seq(.25, .45, .1)))

par(mar =  c(4, 4, 1, 1)) 
with(dat,plot(propEnclosed ~ VPDAnnual,
              pch="o",
              cex=0.6,
              xlab="VPD (kPa)", 
              ylab = "Enclosed nest (proportion)",
              frame=F))
box(which = "plot", bty = "l")
    abline(SARlmEnc$coefficients[1],SARlmEnc$coefficients[2],col="blue",lwd=2)

myr2 = bquote(italic(R)^2 == 0.55)
text(x = 1.5, y = 0.23, labels = myr2)

 

dev.off()  
    
    
    
    



```{r,echo=FALSE}



########################################

#CI scores
#function to make map CI Score using bootstrap methodo

# #######################################
# # 
# #make dataframe of unique grid cells and species richness
#  zdat<-as.data.frame(table(Occ$ID))
# 
# #species richenss map
# richness<-subs(aus, data.frame(zdat[,c("Var1","Freq")]))
# plot(richness,main = "Species richness")
# 
#  
# CIBOOT<-function (GridCell,GriddedOccurance,traitData,traitOfInterst){ 
#     sp<-as.character(subset(GriddedOccurance,ID==GridCell)[,"Species"])
#     tr<-traitData[traitData$Species %in% sp,]#pull out the traits for the species of interest
#     obs_data<-na.omit(tr[,paste(traitOfInterst)])
#     bootdat<-bootstrap(obs_data, mean(obs_data), R = 10000)
#     obs_se <- bootdat$stats$SE
#     CI<-obs_se*2 #95% CI
#     spCount<-length(sp)
#     spWithknownValue<-length(obs_data)
#     dfOUT<-cbind(GridCell,CI,spCount,spWithknownValue)
#     return(dfOUT)
# }
# 
# 
# #loop through cells and get average trait values
# CIscores<-list()
# propCIscores<-list()
# for(ID in 1:length(unique(Occ$ID))){ 
# CIscores[[ID]]<- CIBOOT(GridCell=unique(Occ$ID)[ID],
#                  GriddedOccurance=Occ,
#                  traitData=traits,
#                  traitOfInterst="Elongation")
#   
# 
# propCIscores[[ID]]<- CIBOOT(GridCell=unique(Occ$ID)[ID],
#                  GriddedOccurance=Occ,
#                  traitData=traits,
#                  traitOfInterst="roof")
# 
# message(ID)
# }
# 
# elongCIscores<-as.data.frame(do.call("rbind",CIscores))
# elongCIsore<-subs(aus, data.frame(elongCIscores[,c("GridCell","CI")]))
# plot(elongCIsore,main = "CI")
# 
#   
# PropCIscores<-as.data.frame(do.call("rbind",propCIscores))
# PropCIsoreR<-subs(aus, data.frame(na.omit(PropCIscores[,c("GridCell","CI")])))
# plot(PropCIsoreR,main = "CI")
# 
# 


################



```

# test to see if elongation changes within a species due to differences in VPD
#
# **Removed all values from QVM - the were incorrectly entered into the .csv file
#
# mixed effect model with VPD as fixed effect and nest ID as random effects
#
# "Linear mixed-effects models were used to assess how within species egg elongation changed in response to VPD. ANOVA was calculated using an Analysis of Deviance Table (Type II Wald F tests with Kenward-Roger approximation for degrees-of-freedom). In our models for each species  VPD was a fixed effect and nest ID was a random effect to account for differences in egg shape within a single nest."
#

```{r,echo=FALSE}


#species of interest
species<-c("Cracticus tibicen","Petrochelidon ariel","Zosterops lateralis",
           "Anthus australis","Rhipidura leucophrys","Grallina cyanoleuca",
           "Petrochelidon nigricans","Taeniopygia bichenovii","Pachycephala rufiventris",
           "Rhipidura albiscapa","Pomatostomus temporalis","Melanodryas cucullata",
           "Manorina melanocephala","Anthus novaeseelandiae")

#rename
nms<-c(names(spDat)[1:12],paste(rep(c("egg_area","egg_length","egg_width"),11),rep(1:11,each=3),sep="."),names(spDat)[46])
colnames(spDat)<-nms

#change to wide format
longDat<-list()
for (l in 1:11){
  df1<-spDat[,c(names(spDat)[1:12],paste(c("egg_area","egg_length","egg_width"),rep(l,3),sep="."),names(spDat)[46])]
  colnames(df1)<-c(names(spDat)[1:12],"egg_area","egg_length","egg_width",names(spDat)[46])
  longDat[[l]]<-df1
}
longDat<-as.data.frame(do.call(rbind,longDat))
longDat<-subset(longDat,!is.na(longDat$egg_area))#remove NA values
longDat<-subset(longDat,!is.na(longDat$egg_length))#remove NA values

#Extract VPD at the locations
longDat$VPD<-extract(VPDann,cbind(longDat$decimalLongitude,longDat$decimalLatitude))

#for cells falling just off the coast use bilinear interpolation to get VPD values
longDatNA<-subset(longDat,is.na(longDat$VPD))
longDat<-subset(longDat,!is.na(longDat$VPD))
longDatNA$VPD<-extract(VPDann,cbind(longDatNA$decimalLongitude,longDatNA$decimalLatitude),method='bilinear')
longDatNA<-subset(longDatNA,!is.na(longDatNA$VPD))
longDat<-rbind(longDat,longDatNA)
longDat$elongation<-with(longDat,egg_length/egg_width)


#loop through each species and find out if egg elongation changes with VPD,
#we expect some species will have decreased elongation with increasing VPD
#some nests have multiple eggs so treat nest ID as random effect

modelDat<-list()
for (sp in 1:length(species)){
  df2<-subset(longDat, Species == species[sp])
  observationCount<-nrow(df2)
  uniqueNests<-length(unique(df2$id))
  #mixed effect model to control for multiple eggs in a nest
  mod1<-lmer(elongation ~ VPD + (1+VPD|id),data=df2,REML=TRUE)#add nest ID
    # #check on spatial autocorrelation
       C_lmEl <- correlog(df2$decimalLongitude, df2$decimalLatitude, residuals(mod1),
                          na.rm=T, increment=100, resamp=0,latlon=TRUE)
      
       plot(0,type="n",col="black",ylab="Moran's I",xlab="lag distance",xlim=c(0,4600),ylim=c(-1,1),main = "Elongation")
       abline(h=0,lty="dotted")
       lines(C_lmEl$correlation~C_lmEl$mean.of.class,col="red",lwd=2)
       plot(VPDann,col="grey70",legend=FALSE,main = species[sp])
       points(df2$decimalLongitude, 
              df2$decimalLatitude, 
              col=c("blue","red")[sign(resid(mod1))/2+1.5],
              pch=19,
              cex=abs(resid(mod1))/max(resid(mod1))*2, 
              add=TRUE)

   qqPlot(residuals(modBP1))
  text(120,-10,paste(sp))
  p<-round(Anova(mod1)$"Pr(>Chisq)",digits = 3)#get p values from lmer
    #text(130,-40,p)
  modAnova<-Anova(mod1, test.statistic="F")
  f<-modAnova$F
  df<-modAnova$Df
  dfRes<-modAnova$"Df.res"

  modelDat[[sp]]<-cbind(species[sp],observationCount,uniqueNests,p,f,df,dfRes)
}

do.call("rbind",modelDat)

# If I wanted to report results for sp <- 14

#F(1, 4.23) = 0.5495518, p = 0.37

# 5  F(1, 10.7) = 5.7, p < 0.05
# 10 F(1, 3.3) = 5.2, p < 0.05
# 13 F(1, 34.5) = 3.4, p < 0.05
# 


```
Since there was no significant results for roofed nest, which could be due to abundance of species, find out the % of species that have roofed nests when their breeding area is at least 50% of biome

```{r,echo=TRUE}

#summarize VPD by biome
dat$koeppen<-extract(koeppen,cbind(dat$x,dat$y))
ddply(dat, "koeppen", function(x) {
  meanVPD <- mean(x$VPDAnnual)
  sd.count <- sd(x$VPDAnnual)
  data.frame(koepSummayr = cbind(meanVPD,sd.count))
  })

#see if significantly different group means

VPDKoep = with(na.omit(dat),lm(formula = VPDAnnual ~ koeppen))
bartlett.test(dat$VPDAnnual, dat$koeppen)#???? ask Remko

Anova(VPDKoep, test.statistic="F")
TukeyVPDKoep<- glht(VPDKoep, linfct=mcp(koeppen="Tukey"))#find differencs between regions
summary(TukeyVPDKoep)


#for each species calculate the proportion of breeding habitat in a particular biome
koepProp<-list()
for(i in 1: length(traits$Species)){
  df3<-subset(Occ,Species==as.vector(traits$Species[i]))
  cells<-length(na.omit(df3$koeppen))
  tropical<-nrow(subset(df3,koeppen==35))/cells
  subtropical<-nrow(subset(df3,koeppen==32))/cells
  temperate<-nrow(subset(df3,koeppen==3))/cells
  grassland<-nrow(subset(df3,koeppen==13))/cells
  desert<-nrow(subset(df3,koeppen==22))/cells
  koepProp[[i]]<-cbind(tropical,subtropical,temperate,grassland,desert)
}

koepProp<-as.data.frame(do.call("rbind",koepProp))
colnames(koepProp)<-c("tropical","subtropical","temperate","grassland","desert")
koepProp$Species<-traits$Species
koepProp<- factorsNumeric(koepProp[,c("tropical",
                                    "subtropical",
                                    "temperate",
                                    "grassland",
                                    "desert")])
koepProp$Species<-traits$Species

traits<-merge(traits,koepProp,by="Species")

t2<-subset(traits,nest.loc != "Cavity")

#how many species top 10% of elongated species occur in tropics or subtropics
traits$tropics<-with(traits,tropical+subtropical)
newdata <- traits[order(traits$Elongation, -traits$tropics),]
#30 species have elongation greater than 1.45
newdata<-subset(newdata,Elongation>=1.45 & tropics >=.5)

#how many of least elongated specie live predominately in desert or grassland



  #desert
  nrow(subset(t2,desert >= .5 &Exposure=="Enclosed"))/nrow(subset(t2,desert >= .5))*100
  #grassland
  nrow(subset(t2,grassland >= .5 &Exposure=="Enclosed"))/nrow(subset(t2,grassland >= .5))*100
  #temperate
  nrow(subset(t2,temperate >= .5 &Exposure=="Enclosed"))/nrow(subset(t2,temperate >= .5))*100
  #subtropical
  nrow(subset(t2,subtropical >= .5 &Exposure=="Enclosed"))/nrow(subset(t2,subtropical >= .5))*100
  #tropical
  nrow(subset(t2,tropical >= .5 &Exposure=="Enclosed"))/nrow(subset(t2,tropical >= .5))*100
  
 
```



